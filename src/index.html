<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No-AI Summarizer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
        }
        input[type="number"] {
            width: 100px;
            padding: 5px;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 10px;
        }
        input[type="checkbox"] {
            margin-right: 5px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
        }
        .slider-value {
            font-weight: bold;
            color: #333;
        }
        .page-inputs {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .page-inputs input:disabled {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.error {
            background-color: #ffe6e6;
            color: #cc0000;
        }
        .status.success {
            background-color: #e6ffe6;
            color: #006600;
        }
        .status.processing {
            background-color: #e6f3ff;
            color: #0066cc;
        }
        
        /* A/B Test Styles */
        #normalResult, #abTestResult {
            display: none;
        }
        
        .ab-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .ab-option {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .ab-option h3 {
            margin-top: 0;
            color: #333;
        }
        
        .ab-option textarea {
            height: 300px;
            margin-bottom: 10px;
        }
        
        .prefer-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .prefer-btn:hover {
            background: #0056b3;
        }
        
        .ab-header {
            text-align: center;
            margin-bottom: 15px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>No-AI Summarizer</h1>
    
    <div class="control-group">
        <label for="slider">
            Summary Length: <span class="slider-value" id="sliderValue"></span>%
        </label>
        <input type="range" id="slider" min="0.0" max="50.0" value="1.0" step="0.01">
    </div>
    
    <div class="control-group">
        <label>
            <input type="checkbox" id="allPages" checked>
            All Pages
        </label>
        <div class="page-inputs">
            <div>
                <label for="startPage">Start Page:</label>
                <input type="number" id="startPage" min="1" value="1" disabled>
            </div>
            <div>
                <label for="endPage">End Page:</label>
                <input type="number" id="endPage" min="1" value="1" disabled>
            </div>
        </div>
    </div>
    
    <div class="control-group">
        <label for="pdfFile">Upload File:</label>
        <input type="file" id="pdfFile" accept=".pdf,.docx,.txt">
    </div>
    
    <div class="control-group">
        <button id="processButton">Process File</button>
    </div>
    
    <div id="statusMessage"></div>
    
    <!-- Normal Result (Original UI) -->
    <div id="normalResult">
        <div class="control-group">
            <label for="output">Summary:</label>
            <textarea id="output" placeholder="Summary will appear here..."></textarea>
            <button id="copyButton" style="margin-top: 10px; font-size: 18px;">ðŸ“‹</button>
        </div>
    </div>
    
    <!-- A/B Test Result (New UI) -->
    <div id="abTestResult">
        <h2 class="ab-header">Which summary is better? Please select your preference:</h2>
        <div class="ab-container">
            <div class="ab-option">
                <h3>Option A</h3>
                <textarea id="optionA" readonly></textarea>
                <button class="prefer-btn" onclick="selectPreference('a')">Choose Option A</button>
            </div>
            <div class="ab-option">
                <h3>Option B</h3>
                <textarea id="optionB" readonly></textarea>
                <button class="prefer-btn" onclick="selectPreference('b')">Choose Option B</button>
            </div>
        </div>
    </div>

    <script>
        const slider = document.getElementById('slider');
        const sliderValue = document.getElementById('sliderValue');
        const allPagesCheckbox = document.getElementById('allPages');
        const startPage = document.getElementById('startPage');
        const endPage = document.getElementById('endPage');
        const pdfFileInput = document.getElementById('pdfFile');
        const processButton = document.getElementById('processButton');
        const output = document.getElementById('output');
        const statusMessage = document.getElementById('statusMessage');
        const normalResult = document.getElementById('normalResult');
        const abTestResult = document.getElementById('abTestResult');
        const optionA = document.getElementById('optionA');
        const optionB = document.getElementById('optionB');
        
        const API_URL = 'https://abridged-production.up.railway.app';
        let currentTestId = null;
        let currentTestData = null; // Store complete test data
        
        // Update slider value display
        slider.addEventListener('input', function() {
            sliderValue.textContent = this.value;
        });
        
        // Handle "All Pages" checkbox
        allPagesCheckbox.addEventListener('change', function() {
            startPage.disabled = this.checked;
            endPage.disabled = this.checked;
        });
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.style.display = 'block';
        }
        
        // Hide status message
        function hideStatus() {
            statusMessage.style.display = 'none';
        }
        
        // Display result based on mode
        function displayResult(data) {
            if (data.mode === 'normal') {
                // Show normal single result
                normalResult.style.display = 'block';
                abTestResult.style.display = 'none';
                output.value = data.summary;
                showStatus('Processing complete!', 'success');
            } else if (data.mode === 'ab_test') {
                // Show A/B test options
                normalResult.style.display = 'none';
                abTestResult.style.display = 'block';
                optionA.value = data.option_a;
                optionB.value = data.option_b;
                currentTestId = data.test_id;
                
                // Store all test data for later submission
                currentTestData = {
                    test_id: data.test_id,
                    option_a: data.option_a,
                    option_b: data.option_b,
                    theta_a: data.theta_a,
                    theta_b: data.theta_b
                };
                
                showStatus('Processing complete! Please select your preferred summary.', 'success');
            }
        }
        
        // Handle preference selection
        // Handle preference selection
        async function selectPreference(choice) {
            try {
                showStatus('Recording your preference...', 'processing');
                
                // Send complete data including both options and choice
                await fetch(`${API_URL}/record-preference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test_id: currentTestData.test_id,
                        choice: choice,
                        option_a: currentTestData.option_a,
                        option_b: currentTestData.option_b,
                        theta_a: currentTestData.theta_a,
                        theta_b: currentTestData.theta_b,
                        timestamp: new Date().toISOString()
                    })
                });
                
                showStatus('Thank you for your feedback!', 'success');
                
                // Get the chosen text
                const chosenText = choice === 'a' ? currentTestData.option_a : currentTestData.option_b;
                
                // Switch to normal view with chosen summary
                abTestResult.style.display = 'none';
                normalResult.style.display = 'block';
                output.value = chosenText;
                
                // Hide success message after a delay
                setTimeout(hideStatus, 2000);
                
            } catch (error) {
                showStatus(`Error recording preference: ${error.message}`, 'error');
                console.error('Preference error:', error);
            }
        }

        // Process file button click handler
        processButton.addEventListener('click', async function() {
            // Get the slider value
            const sliderVal = slider.value;
            
            // Get page numbers (or -1 for all pages)
            let startPageVal = -1;
            let endPageVal = -1;
            
            if (!allPagesCheckbox.checked) {
                startPageVal = parseInt(startPage.value);
                endPageVal = parseInt(endPage.value);
                
                // Validate page numbers
                if (startPageVal < 1 || endPageVal < 1) {
                    showStatus('Page numbers must be at least 1', 'error');
                    return;
                }
                
                if (startPageVal > endPageVal) {
                    showStatus('Start page must be less than or equal to end page', 'error');
                    return;
                }
            }
            
            // Get the uploaded file
            const file = pdfFileInput.files[0];
            
            // Validate that a file is selected
            if (!file) {
                showStatus('Please select a file first', 'error');
                return;
            }
            
            // Disable button during processing
            processButton.disabled = true;
            showStatus('Processing...', 'processing');
            output.value = '';
            
            // Hide both result sections
            normalResult.style.display = 'none';
            abTestResult.style.display = 'none';
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('slider_value', sliderVal);
                formData.append('start_page', startPageVal);
                formData.append('end_page', endPageVal);
                
                // Send request to backend
                const response = await fetch(`${API_URL}/upload-pdf`, {
                    method: 'POST',
                    body: formData
                });
                
                // Parse response
                const result = await response.json();
                
                if (response.ok) {
                    // Display the result (normal or A/B test)
                    displayResult(result);
                } else {
                    // Display error
                    showStatus(`Error: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error:', error);
            } finally {
                // Re-enable button
                processButton.disabled = false;
            }
        });
        
        // Copy to clipboard button handler
        document.getElementById('copyButton').addEventListener('click', async function() {
            const text = output.value;
            
            if (!text) {
                showStatus('Nothing to copy', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showStatus('Copied to clipboard!', 'success');
                setTimeout(hideStatus, 2000); // Hide after 2 seconds
            } catch (error) {
                showStatus('Failed to copy to clipboard', 'error');
                console.error('Copy error:', error);
            }
        });
        
        // Initialize slider display
        sliderValue.textContent = slider.value;
    </script>
</body>
</html>